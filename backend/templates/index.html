<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Adaptive Cyber-Physical Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: #38bdf8; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .card { background: #1e293b; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .metrics { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .metric { text-align: center; }
        .metric-value { font-size: 24px; font-weight: bold; color: #38bdf8; }
        .metric-label { font-size: 14px; opacity: 0.7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Adaptive Control System Dashboard</h1>
        
        <div class="card metrics" id="metrics-card">
            <div class="metric">
                <div class="metric-value" id="mse-val">0.00</div>
                <div class="metric-label">MSE (Adaptive)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="convergence-val">Idle</div>
                <div class="metric-label">Status</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="sensitivity-val">1.0</div>
                <div class="metric-label">Plant Sensitivity</div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>System Output (Reference vs Actual)</h3>
                <canvas id="outputChart"></canvas>
            </div>
            <div class="card">
                <h3>Control Efforts (U)</h3>
                <canvas id="controlChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const ctxOutput = document.getElementById('outputChart').getContext('2d');
        const ctxControl = document.getElementById('controlChart').getContext('2d');

        const outputChart = new Chart(ctxOutput, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Reference', borderColor: 'rgba(239, 68, 68, 0.8)', data: [], borderDash: [5, 5], borderWidth: 2, fill: false, pointRadius: 0 },
                    { label: 'Adaptive', borderColor: 'rgba(56, 189, 248, 1)', data: [], borderWidth: 3, fill: false, pointRadius: 0 },
                    { label: 'PID', borderColor: 'rgba(34, 197, 94, 0.6)', data: [], borderWidth: 2, fill: false, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                    y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                },
                plugins: { legend: { labels: { color: 'white' } } }
            }
        });

        const controlChart = new Chart(ctxControl, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'U Adaptive', borderColor: 'rgba(56, 189, 248, 1)', data: [], borderWidth: 2, fill: false, pointRadius: 0 },
                    { label: 'U PID', borderColor: 'rgba(34, 197, 94, 0.6)', data: [], borderWidth: 2, fill: false, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                    y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                },
                plugins: { legend: { labels: { color: 'white' } } }
            }
        });

        async function updateDashboard() {
            try {
                const response = await fetch('/analytics');
                const data = await response.json();
                
                const labels = data.reference.map((_, i) => i);
                
                outputChart.data.labels = labels;
                outputChart.data.datasets[0].data = data.reference;
                outputChart.data.datasets[1].data = data.adaptive;
                outputChart.data.datasets[2].data = data.pid;
                outputChart.update('none');

                controlChart.data.labels = labels;
                controlChart.data.datasets[0].data = data.u_adaptive;
                controlChart.data.datasets[1].data = data.u_pid;
                controlChart.update('none');

                // Update metrics if available
                if (data.adaptive.length > 0) {
                    const latestRef = data.reference[data.reference.length - 1];
                    const latestAct = data.adaptive[data.adaptive.length - 1];
                    const mse = (latestRef - latestAct) ** 2;
                    document.getElementById('mse-val').innerText = mse.toFixed(4);
                    document.getElementById('convergence-val').innerText = 'Active';
                }
            } catch (error) {
                console.error("Dashboard error:", error);
            }
        }

        setInterval(updateDashboard, 500);
    </script>
</body>
</html>
